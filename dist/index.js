// @bun
var xe=Object.defineProperty;var Q=(e,s)=>{for(var o in s)xe(e,o,{get:s[o],enumerable:!0,configurable:!0,set:(t)=>s[o]=()=>t})};var E={FAILSAFE:!1,FAILSAFE_POINTS:[[0,0]],PAUSE:!1,PAUSE_DELAY:10};var h={};Q(h,{keyboard:()=>ye});import{ptr as se}from"bun:ffi";import{dlopen as Ee,FFIType as a,suffix as pe}from"bun:ffi";var f=Ee(`user32.${pe}`,{SendInput:{args:[a.u32,a.ptr,a.i32],returns:a.u32},MapVirtualKeyW:{args:[a.u32,a.u32],returns:a.u32},GetCursorPos:{args:[a.ptr],returns:a.bool},GetSystemMetrics:{args:[a.i32],returns:a.i32},GetKeyState:{args:[a.i32],returns:a.i16},GetAsyncKeyState:{args:[a.i32],returns:a.i16},SetWindowsHookExW:{args:[a.i32,a.ptr,a.ptr,a.u32],returns:a.ptr},UnhookWindowsHookEx:{args:[a.ptr],returns:a.bool},CallNextHookEx:{args:[a.ptr,a.i32,a.ptr,a.ptr],returns:a.ptr}});class d{buffer;view;constructor(e=0,s=0,o=0,t=0,n=0,r=0n){this.buffer=new ArrayBuffer(32),this.view=new DataView(this.buffer),this.view.setInt32(0,e,!0),this.view.setInt32(4,s,!0),this.view.setUint32(8,o,!0),this.view.setUint32(12,t,!0),this.view.setUint32(16,n,!0),this.view.setBigUint64(20,BigInt(r),!0)}}class U{buffer;view;constructor(e=0,s=0,o=0,t=0,n=0n){this.buffer=new ArrayBuffer(32),this.view=new DataView(this.buffer),this.view.setUint16(0,e,!0),this.view.setUint16(2,s,!0),this.view.setUint32(4,o,!0),this.view.setUint32(8,t,!0),this.view.setBigUint64(12,BigInt(n),!0)}}class c{buffer;view;constructor(e,s){this.buffer=new ArrayBuffer(40),this.view=new DataView(this.buffer),this.view.setUint32(0,e,!0);let o=new Uint8Array(s.buffer);new Uint8Array(this.buffer).set(o,8)}}class N extends Error{constructor(e){super(e);this.name="FailSafeException"}}import{ptr as ce}from"bun:ffi";function m(){if(E.FAILSAFE){let e=w();for(let s of E.FAILSAFE_POINTS)if(e[0]===s[0]&&e[1]===s[1])throw new N("DirectInput fail-safe triggered from mouse moving to a corner of the screen. To disable this fail-safe, set config.FAILSAFE to false. DISABLING FAIL-SAFE IS NOT RECOMMENDED.")}}function l(e){if(e&&E.PAUSE_DELAY>0)Bun.sleepSync(E.PAUSE_DELAY)}function Z(e=0,s=0){let[o,t]=le(),n=Math.round(e*65535/(o-1)),r=Math.round(s*65535/(t-1)),u=Math.max(0,Math.min(65535,n)),i=Math.max(0,Math.min(65535,r));return[u,i]}function w(e,s){let o=new ArrayBuffer(8),t=new DataView(o);f.symbols.GetCursorPos(ce(o));let n=t.getInt32(0,!0),r=t.getInt32(4,!0);return[e??n,s??r]}function le(){let e=f.symbols.GetSystemMetrics(0),s=f.symbols.GetSystemMetrics(1);return[e,s]}var _=1,ee=32768,F=2,V=4;var P=8,L=16;var k=32,C=64;var B=128,R=256,G=1,Y=2,X=1,te=2,W=8;var K=0;var b={escape:1,esc:1,f1:59,f2:60,f3:61,f4:62,f5:63,f6:64,f7:65,f8:66,f9:67,f10:68,f11:87,f12:88,printscreen:183,prntscrn:183,prtsc:183,prtscr:183,scrolllock:70,pause:197,"`":41,"1":2,"2":3,"3":4,"4":5,"5":6,"6":7,"7":8,"8":9,"9":10,"0":11,"-":12,"=":13,backspace:14,insert:1234,home:1223,pageup:1225,pagedown:1233,del:1235,delete:1235,end:1231,numlock:69,divide:1205,multiply:55,subtract:74,add:78,decimal:83,numpad0:82,numpad1:79,numpad2:80,numpad3:81,numpad4:75,numpad5:76,numpad6:77,numpad7:71,numpad8:72,numpad9:73,numpadenter:1180,tab:15,q:16,w:17,e:18,r:19,t:20,y:21,u:22,i:23,o:24,p:25,"[":26,"]":27,"\\":43,capslock:58,a:30,s:31,d:32,f:33,g:34,h:35,j:36,k:37,l:38,";":39,"'":40,enter:28,return:28,shift:42,shiftleft:42,z:44,x:45,c:46,v:47,b:48,n:49,m:50,",":51,".":52,"/":53,shiftright:54,ctrl:29,ctrlleft:29,win:1243,winleft:1243,alt:56,altleft:56," ":57,space:57,altright:1208,winright:1244,apps:1245,ctrlright:1181,up:f.symbols.MapVirtualKeyW(38,K),left:f.symbols.MapVirtualKeyW(37,K),down:f.symbols.MapVirtualKeyW(40,K),right:f.symbols.MapVirtualKeyW(39,K)},H=new Map([["!","1"],["@","2"],["#","3"],["$","4"],["%","5"],["^","6"],["&","7"],["*","8"],["(","9"],[")","0"],["_","-"],["+","="],["{","["],["}","]"],["|","\\"],[":",";"],['"',"'"],["<",","],[">","."],["?","/"],["~","`"]]);function D(e,s=E.PAUSE){m();let o=W;if(["up","left","down","right"].includes(e))o|=X;let t=b[e],n=new U(0,t,o,0),r=new c(1,n);if(f.symbols.SendInput(1,se(r.buffer),40),s)l(s);return h}function g(e,s=E.PAUSE){m();let o=W|te;if(["up","left","down","right"].includes(e))o|=X;let t=b[e],n=new U(0,t,o,0),r=new c(1,n);if(f.symbols.SendInput(1,se(r.buffer),40),s)l(s);return h}function T(e,s=1,o=0,t=E.PAUSE){for(let n=0;n<s;n++)if(m(),D(e,!1),g(e,!1),o>0)Bun.sleepSync(o);if(t)l(t);return h}function oe(e,s=0,o=E.PAUSE){for(let t of e){if(m(),t!==t.toLowerCase()){let n=t.toLowerCase();D("shift"),T(n),g("shift")}else if(H.has(t)){let n=H.get(t);D("shift"),T(n),g("shift")}else T(t);if(s>0)Bun.sleepSync(s)}if(o)l(o);return h}var ne={};for(let[e,s]of Object.entries(b))ne[s&4095]=e;var de=new Set([1,2,4,5,6]);class ${listeners=new Map;isRunning=!1;on(e,s){if(!this.listeners.has(e))this.listeners.set(e,new Set);this.listeners.get(e).add(s)}off(e,s){this.listeners.get(e)?.delete(s)}once(e,s){let o=(t)=>{s(t),this.off(e,o)};this.on(e,o)}listen(e){this.on("keydown",e),this.on("keyup",e)}_emit(e,s){this.listeners.get(e)?.forEach((o)=>{try{o(s)}catch(t){console.error(`Keyboard event error [${e}]:`,t)}})}async startListener(e=8){if(this.isRunning)return;this.isRunning=!0,console.log("Keyboard listener started.");let s=Array(256).fill(!1),o=Array.from({length:256},(t,n)=>n);while(this.isRunning){for(let t of o){if(de.has(t))continue;let n=f.symbols.GetAsyncKeyState(t),r=(n&32768)!==0,u=(n&1)!==0,i,p=f.symbols.MapVirtualKeyW(t,0);if(i=ne[p],!i)if(t>=48&&t<=90)i=String.fromCharCode(t).toLowerCase();else if(t===13)i="enter";else if(t===16)i="shift";else if(t===17)i="ctrl";else if(t===18)i="alt";else if(t===9)i="tab";else if(t===20)i="capslock";else if(t===27)i="escape";else if(t===32)i="space";else if(t>=112&&t<=123)i=`f${t-111}`;else i=`vk_${t.toString(16).padStart(2,"0")}`;if(r!==s[t]){s[t]=r;let x={event:r?"down":"up",name:i,vk_code:t,isKeyDown:r};this._emit(r?"keydown":"keyup",x)}else if(!r&&u&&!s[t]){let x={event:"down",name:i,vk_code:t,isKeyDown:!0};this._emit("keydown",x),this._emit("keyup",{...x,event:"up",isKeyDown:!1})}}await Bun.sleep(e)}console.log("Keyboard listener stopped.")}stopListener(){this.isRunning=!1}}class re{down=D;up=g;press=T;write=oe;listener=new $}var ye=new re;var v={};Q(v,{mouse:()=>he});import{ptr as S}from"bun:ffi";var y="left",A="right",I="middle",j="x1",z="x2";function ie(e,s,o=y,t=E.PAUSE){if(e!==void 0||s!==void 0)M(e,s);let n,r=0;if(o===y)n=F;else if(o===I)n=k;else if(o===A)n=P;else if(o===j)n=B,r=G;else if(o===z)n=B,r=Y;else throw Error(`button must be "left", "middle", "right", "x1", or "x2", not ${o}`);let u=new d(0,0,r,n,0),i=new c(0,u);if(f.symbols.SendInput(1,S(i.buffer),40),t)l(t);return v}function fe(e,s,o=y,t=E.PAUSE){if(e!==void 0||s!==void 0)M(e,s);let n,r=0;if(o===y)n=V;else if(o===I)n=C;else if(o===A)n=L;else if(o===j)n=R,r=G;else if(o===z)n=R,r=Y;else throw Error(`button must be "left", "middle", "right", "x1", or "x2", not ${o}`);let u=new d(0,0,r,n,0),i=new c(0,u);if(f.symbols.SendInput(1,S(i.buffer),40),t)l(t);return v}function ae(e,s,o=1,t=0,n=y,r=E.PAUSE){if(e!==void 0||s!==void 0)M(e,s);if([y,I,A].includes(n)){let u=0,i=0;if(n===y)u=F,i=V;else if(n===I)u=k,i=C;else u=P,i=L;for(let p=0;p<o;p++)if(m(),f.symbols.SendInput(1,S(new c(0,new d(0,0,0,u,0)).buffer),40),f.symbols.SendInput(1,S(new c(0,new d(0,0,0,i,0)).buffer),40),t>0)Bun.sleepSync(t*1000)}if(r)l(r);return v}function M(e,s,o=E.PAUSE,t=!1){if(m(),!t){let[n,r]=w(e,s),[u,i]=Z(n,r),p=new d(u,i,0,_|ee,0),x=new c(0,p);f.symbols.SendInput(1,S(x.buffer),40)}else{let[n,r]=w();q((e??n)-n,(s??r)-r,o,!0)}if(o)l(o);return v}function q(e=0,s=0,o=E.PAUSE,t=!1){if(m(),!t){let[n,r]=w();M(n+e,r+s,o)}else{let n=new d(e,s,0,_,0),r=new c(0,n);if(f.symbols.SendInput(1,S(r.buffer),40),o)l(o)}return v}import{ptr as ve}from"bun:ffi";class J{listeners=new Map;isRunning=!1;on(e,s){if(!this.listeners.has(e))this.listeners.set(e,new Set);this.listeners.get(e).add(s)}off(e,s){this.listeners.get(e)?.delete(s)}once(e,s){let o=(t)=>{s(t),this.off(e,o)};this.on(e,o)}listen(e){this.on("move",e),this.on("down",e),this.on("up",e)}_emit(e,s){this.listeners.get(e)?.forEach((o)=>{try{o(s)}catch(t){console.error(`Mouse event error [${e}]:`,t)}})}async startListener(e=8){if(this.isRunning)return;this.isRunning=!0,console.log("Mouse listener started.");let s=new ArrayBuffer(8),o=new DataView(s),t={x:0,y:0},n={left:!1,right:!1,middle:!1,x1:!1,x2:!1};while(this.isRunning){f.symbols.GetCursorPos(ve(s));let r=o.getInt32(0,!0),u=o.getInt32(4,!0);if(r!==t.x||u!==t.y){let x={event:"move",x:r,y:u,lastX:t.x,lastY:t.y,deltaX:r-t.x,deltaY:u-t.y};this._emit("move",x),t.x=r,t.y=u}let i={left:f.symbols.GetAsyncKeyState(1),right:f.symbols.GetAsyncKeyState(2),middle:f.symbols.GetAsyncKeyState(4),x1:f.symbols.GetAsyncKeyState(5),x2:f.symbols.GetAsyncKeyState(6)},p=Object.fromEntries(Object.entries(i).map(([x,O])=>[x,(O&32768)!==0]));for(let x of Object.keys(n))if(p[x]!==n[x]){n[x]=p[x];let O={event:p[x]?"down":"up",button:x,x:t.x,y:t.y};this._emit(p[x]?"down":"up",O)}await Bun.sleep(e)}console.log("Mouse listener stopped.")}stopListener(){this.isRunning=!1}}class ue{get position(){let e=w();return{x:e[0],y:e[1]}}down=ie;up=fe;click=ae;moveTo=M;moveRel=q;listener=new J}var he=new ue;export{he as mouse,ye as keyboard,E as config};
